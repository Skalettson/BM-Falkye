# Архитектура мода BM Falkye

## Обзор

BM Falkye - это карточная игра для Minecraft 1.20.1 (Forge), вдохновлённая стратегическими карточными играми. Мод построен на модульной архитектуре с чётким разделением ответственности между компонентами.

## Версия 3.0 - Реализация Гранд-стратегии

Мод был полностью обновлён согласно Гранд-стратегии развития с реализацией всех 4 фаз:
- ✅ Фаза 1: Эволюция карт, Легендарные квесты, Зал Дуэлей
- ✅ Фаза 2: Драфт/Арена, Пользовательские турниры, Лидерборды, Аналитика
- ✅ Фаза 3: API для модмейкеров, Территориальная война, Командный режим 2v2
- ✅ Фаза 4: 3D режим, Экосистема косметики

## Основные компоненты

### 1. Игровая логика (`com.bmfalkye.game`)

#### FalkyeGameSession
**Назначение:** Центральный класс, управляющий состоянием игровой сессии.

**Основные обязанности:**
- Управление состоянием игры (раунды, очки, ходы)
- Обработка действий игроков (разыгрывание карт, пас, использование лидера)
- Расчёт очков раунда с учётом модификаторов и погоды
- Управление картами на поле (3 ряда: ближний бой, дальний бой, осада)
- Обработка окончания раундов и игры
- Поддержка режима Драфт Арены
- Поддержка трансляции для зрителей

**Ключевые структуры данных:**
- `powerModifiers`: Модификаторы силы карт по игрокам
- `cardBuffs`: Баффы/дебаффы карт
- `revealedCards`: Показанные карты оппонента
- `usedCards`: Отслеживание использованных карт
- `draftArena`: Флаг режима драфт арены
- `draftSession`: Связь с сессией драфта

#### GameManager
**Назначение:** Управление жизненным циклом игровых сессий.

**Основные обязанности:**
- Создание и завершение игровых сессий
- Управление вызовами между игроками
- Синхронизация состояния игры между клиентом и сервером
- Интеграция с системами защиты
- Проверка и запуск игровых событий через GameEventSystem

#### TeamGameSession
**Назначение:** Игровая сессия для командного режима 2v2.

**Основные обязанности:**
- Управление состоянием командной игры
- Синхронизация ходов между игроками команды
- Обработка комбо-способностей
- Управление общим полем (4 ряда)

### 2. Система карт (`com.bmfalkye.cards`)

#### CardRegistry
**Назначение:** Реестр всех карт в игре.

**Основные обязанности:**
- Регистрация и хранение карт
- Поиск карт по ID, фракции, редкости, типу
- Предоставление доступа к картам через API

#### LeaderRegistry
**Назначение:** Реестр лидеров для каждой фракции.

**Основные обязанности:**
- Регистрация лидеров
- Хранение способностей лидеров
- Предоставление доступа к лидерам

#### CardEffects
**Основные обязанности:**
- Применение эффектов заклинаний (SPELL)
- Применение эффектов специальных карт (SPECIAL)
- Обработка погодных эффектов
- Интеграция с API способностей через AbilityRegistry

### 3. Система эволюции карт (`com.bmfalkye.evolution`)

#### CardEvolutionSystem
**Назначение:** Управление эволюцией карт.

**Основные обязанности:**
- Начисление опыта картам за использование
- Обработка повышения уровня
- Применение улучшений из древа эволюции
- Проверка возможности разблокировки веток

#### CardEvolutionTree
**Назначение:** Определение деревьев эволюции для карт.

**Основные обязанности:**
- Хранение структуры деревьев эволюции
- Определение веток и улучшений
- Предоставление доступа к деревьям

#### CardEvolutionStorage
**Назначение:** Хранение данных эволюции карт игроков.

**Особенности:**
- Использует SavedData для персистентности
- Хранит опыт, уровень и разблокированные улучшения

### 4. Система квестов (`com.bmfalkye.quests`)

#### QuestSystem
**Назначение:** Управление квестами игроков.

**Основные обязанности:**
- Отслеживание прогресса квестов
- Проверка выполнения условий
- Выдача наград при завершении

#### LegendaryQuest
**Назначение:** Специальные легендарные квесты.

**Особенности:**
- Уникальные условия активации
- Особые награды (карты, достижения)
- Интеграция с системой предметов

#### QuestStorage
**Назначение:** Хранение прогресса квестов.

### 5. Зал Дуэлей (`com.bmfalkye.duelhall`)

#### DuelHallManager
**Назначение:** Управление структурами Зала Дуэлей.

**Основные обязанности:**
- Обнаружение многоблочных структур
- Управление владельцами
- Предоставление доступа к системам мода

#### DuelHallStructure
**Назначение:** Определение структуры Зала Дуэлей.

**Структура:**
- 1 Картографический Стол (центр)
- 8 Книжных Полок (окружение)
- 1 Стол Алхимика (дополнительный блок)

### 6. Режим Драфт/Арена (`com.bmfalkye.draft`)

#### DraftSystem
**Назначение:** Управление процессом драфта.

**Основные обязанности:**
- Создание сессий драфта
- Предложение карт для выбора
- Формирование колоды из выбранных карт

#### DraftArenaManager
**Назначение:** Управление ареной после драфта.

**Основные обязанности:**
- Матчмейкинг (PvP или AI)
- Отслеживание побед/поражений
- Выдача наград по результатам

#### DraftStorage
**Назначение:** Хранение состояния драфта игроков.

### 7. Система турниров (`com.bmfalkye.tournament`)

#### TournamentSystem
**Назначение:** Управление официальными турнирами.

**Основные обязанности:**
- Создание и управление турнирами
- Формирование сетки
- Выдача призов

#### CustomTournamentSystem
**Назначение:** Управление пользовательскими турнирами.

**Основные обязанности:**
- Создание турниров игроками
- Регистрация участников
- Управление призовым фондом (с комиссией 10%)
- Автоматическое формирование сетки

#### TournamentSpectatorManager
**Назначение:** Управление зрителями турниров.

**Основные обязанности:**
- Добавление/удаление зрителей
- Синхронизация состояния игры для зрителей
- Управление трансляциями

### 8. Лидерборды и Аналитика (`com.bmfalkye.leaderboard`, `com.bmfalkye.analytics`)

#### WeeklyLeaderboardSystem
**Назначение:** Управление еженедельными рейтингами.

**Основные обязанности:**
- Обновление очков игроков
- Еженедельный сброс
- Выдача титула "Завоеватель Недели"

#### LegendRankTracker
**Назначение:** Отслеживание достижения ранга Легенда.

**Основные обязанности:**
- Запись игроков, достигших Легенды
- Отслеживание сезонов
- Предоставление данных для Зала Славы

#### GuildLeaderboardSystem
**Назначение:** Рейтинг гильдий.

**Основные обязанности:**
- Расчёт очков гильдий
- Учёт контролируемых территорий
- Ранжирование гильдий

#### AnalyticsSystem
**Назначение:** Сбор и обработка игровой статистики.

**Собираемые данные:**
- Win Rate карт и комбинаций
- Соотношение побед между фракциями
- Среднее время хода
- Статистика по стратегиям

#### AnalyticsStorage
**Назначение:** Хранение аналитических данных.

### 9. Матчмейкинг и Подсказки (`com.bmfalkye.matchmaking`, `com.bmfalkye.tips`)

#### SmartMatchmakingSystem
**Назначение:** Интеллектуальный подбор оппонентов.

**Факторы подбора:**
- Elo рейтинг
- Размер коллекции
- Схожесть стратегий
- Win Rate карт

#### PersonalTipsSystem
**Назначение:** Генерация персональных подсказок.

**Основа подсказок:**
- Аналитика игрока
- Слабые стороны
- Рекомендации по улучшению

### 10. API для модмейкеров (`com.bmfalkye.api`)

#### FalkyeAPI
**Назначение:** Единая точка доступа для расширения мода.

**Возможности:**
- Регистрация карт через CardBuilder
- Регистрация лидеров через LeaderBuilder
- Регистрация игровых событий через GameEvent
- Регистрация способностей через Ability

**Регистрация через IEventBus:**
```java
FalkyeAPI.registerCard(modBus, CardBuilder.create()...);
FalkyeAPI.registerLeader(modBus, LeaderBuilder.create()...);
FalkyeAPI.registerGameEvent(modBus, new GameEvent(...));
```

#### CardBuilder
**Назначение:** Fluent API для создания карт.

**Методы:**
- `id()`, `name()`, `type()`, `power()`, `faction()`, `rarity()`, `cost()`, `description()`, `ability()`

#### LeaderBuilder
**Назначение:** Fluent API для создания лидеров.

#### Ability
**Назначение:** Интерфейс для создания способностей.

**Хуки:**
- `onPlay()` - при розыгрыше
- `onDeath()` - при смерти карты
- `onRoundEnd()` - в конце раунда
- `onRoundStart()` - в начале раунда

#### GameEvent
**Назначение:** Система случайных событий.

**Особенности:**
- Вероятность срабатывания
- Условия активации
- Кастомная логика выполнения

#### GameEventSystem
**Назначение:** Обработка игровых событий.

**Основные обязанности:**
- Регистрация событий
- Проверка условий срабатывания
- Выполнение событий

### 11. Территориальная Война (`com.bmfalkye.territory`)

#### GuildTerritoryManager
**Назначение:** Управление точками силы.

**Основные обязанности:**
- Хранение состояния точек
- Управление контролем гильдий
- Отслеживание процессов захвата

#### TerritoryCaptureSystem
**Назначение:** Механика захвата территорий.

**Процесс захвата:**
- Установка штандарта (1 минута)
- Оспаривание другой гильдией
- Автоматический запуск дуэли при оспаривании

#### TerritoryBonusSystem
**Назначение:** Применение бонусов за контроль.

**Бонусы:**
- +10% к награде за победу
- Шанс дополнительной монеты

### 12. Командный режим (`com.bmfalkye.team`)

#### TeamGameSession
**Назначение:** Игровая сессия для режима 2v2.

**Особенности:**
- Общее поле (4 ряда)
- Совместная рука
- Синхронизированные ходы
- Комбо-способности

#### TeamComboSystem
**Назначение:** Обработка комбо в командном режиме.

### 13. Косметика (`com.bmfalkye.cosmetics`)

#### CosmeticsStorage
**Назначение:** Хранение косметики игроков.

**Типы косметики:**
- Рубашки карт
- Игровые поля
- Аватары
- Рамки профиля
- Эмоции

#### CardBackSystem
**Назначение:** Система рубашек карт.

**Особенности:**
- Анимированные рубашки
- Звуки тасовки
- Реестр рубашек

#### GameFieldSystem
**Назначение:** Тематические игровые поля.

**Поля:**
- Небесный Дворец
- Лавовые Пещеры
- Грибной Лес

#### AvatarSystem
**Назначение:** Аватары и рамки профиля.

#### EmoteSystem
**Назначение:** Эмоции и жесты.

**Особенности:**
- Отправка эмоций оппоненту
- Анимированные смайлики
- Синхронизация через сеть

### 14. Настройки (`com.bmfalkye.settings`)

#### GameModeSettings
**Назначение:** Управление режимом игры.

**Режимы:**
- MODE_2D - классический режим
- MODE_3D - 3D режим с юнитами

### 15. Клиентская часть (`com.bmfalkye.client`)

#### FalkyeGameScreen
**Назначение:** 2D экран игры.

#### Falkye3DGameScreen
**Назначение:** 3D экран игры.

**Особенности:**
- 3D рендеринг поля
- Отображение юнитов как 3D сущности
- Использование стандартных Minecraft моделей
- Камера с настройками

#### GameSettingsScreen
**Назначение:** Экран настроек игры.

**Функции:**
- Выбор режима игры (2D/3D)
- Настройка отображения

### 16. Хранение данных (`com.bmfalkye.storage`)

Все системы используют SavedData для персистентности:
- `PlayerProgressStorage` - прогресс игрока
- `PlayerCardCollection` - коллекция карт
- `PlayerCurrency` - монеты и Пыль Душ
- `CardEvolutionStorage` - эволюция карт
- `QuestStorage` - квесты
- `DraftStorage` - драфт сессии
- `CustomTournamentStorage` - пользовательские турниры
- `LeaderboardStorage` - лидерборды
- `AnalyticsStorage` - аналитика
- `CosmeticsStorage` - косметика

## Потоки данных

### Игровой цикл

```
1. Игрок отправляет действие (PlayCardPacket, PassPacket, etc.)
   ↓
2. NetworkHandler получает пакет и валидирует через AntiCheatSystem
   ↓
3. GameManager обрабатывает действие через FalkyeGameSession
   ↓
4. FalkyeGameSession обновляет состояние игры
   ↓
5. GameEventSystem проверяет и запускает случайные события
   ↓
6. AnalyticsSystem обновляет статистику
   ↓
7. NetworkHandler отправляет обновлённое состояние всем игрокам
   ↓
8. Клиент обновляет GUI (2D или 3D в зависимости от настроек)
```

### Эволюция карт

```
1. Карта используется в матче
   ↓
2. CardEvolutionSystem начисляет опыт
   ↓
3. Проверка повышения уровня
   ↓
4. Открытие новых веток в древе
   ↓
5. Игрок может разблокировать ветки за Пыль Душ
```

### Драфт/Арена

```
1. Игрок входит в драфт (100 монет или билет)
   ↓
2. DraftSystem предлагает 30 выборов по 3 карты
   ↓
3. Игрок выбирает карты, формируется колода
   ↓
4. DraftArenaManager запускает матчи
   ↓
5. Отслеживание побед/поражений (до 7 побед или 3 поражений)
   ↓
6. Выдача наград по результатам
```

## Зависимости между компонентами

```
FalkyeGameSession
  ├── CardRegistry
  ├── LeaderRegistry
  ├── CardEffects
  ├── CardEvolutionSystem (начисление опыта)
  ├── ComboSystem
  ├── LocationEffect
  ├── ReplaySystem
  └── AnalyticsSystem (сбор статистики)

GameManager
  ├── FalkyeGameSession
  ├── GameEventSystem (проверка событий)
  ├── BetProtectionSystem
  ├── ReconnectManager
  └── TutorialSystem

DraftSystem
  ├── DraftStorage
  ├── DraftArenaManager
  └── PlayerCurrency (входная плата)

CustomTournamentSystem
  ├── CustomTournamentStorage
  ├── TournamentSystem (использование логики)
  └── TournamentSpectatorManager

TerritoryCaptureSystem
  ├── GuildTerritoryManager
  ├── GameManager (запуск дуэлей)
  └── TerritoryBonusSystem (применение бонусов)

TeamGameSession
  ├── TeamComboSystem
  └── NetworkHandler (синхронизация ходов)
```

## Расширяемость

Мод поддерживает расширение через API:

1. **Регистрация карт и лидеров:** Через `FalkyeAPI.registerCard()` и `FalkyeAPI.registerLeader()`
2. **Создание способностей:** Через интерфейс `Ability`
3. **Игровые события:** Через `GameEvent` и `GameEventSystem`
4. **Регистрация через IEventBus:** Как в современных модах Forge

Подробнее см. `DEVELOPER_API.md`.

## Производительность

### Оптимизации

1. **Батчинг пакетов:** Группировка сетевых пакетов
2. **Кэширование:** Кэширование таймеров, текстур, статистики
3. **Очистка памяти:** Автоматическая очистка устаревших данных
4. **Ленивая загрузка:** Загрузка данных только при необходимости
5. **Аналитика:** Оптимизированный сбор статистики

## Безопасность

### Защита от эксплойтов

1. **BetProtectionSystem:** Защита ставок
2. **AntiCheatSystem:** Обнаружение подозрительных действий
3. **InputValidator:** Валидация всех входных данных
4. **DataLoadValidator:** Валидация данных при загрузке

## Тестирование

### Рекомендуемые тесты

1. **Unit тесты:** Для отдельных компонентов
2. **Интеграционные тесты:** Для полного игрового цикла
3. **Тесты производительности:** Для проверки под нагрузкой
4. **Регрессионные тесты:** Для проверки совместимости

## Будущие улучшения

1. Увеличение покрытия тестами до 80%+
2. Расширение API для более глубокой интеграции
3. Оптимизация сетевого взаимодействия
4. Улучшение AI для более сложных стратегий
5. Расширение системы балансировки карт
6. Дополнительные тематические поля
7. Расширение системы эмоций
